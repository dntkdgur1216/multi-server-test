<!DOCTYPE html>
<html>
<head>
    <title>ì•„ì´í…œ ì‡¼í•‘</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 50px auto; }
        .nav { margin-bottom: 20px; }
        .nav a { margin-right: 15px; }
        .item { 
            border: 1px solid #ccc; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px;
        }
        .item h3 { margin: 0 0 10px 0; }
        .stock { color: #666; }
        .stock.low { color: red; font-weight: bold; }
        .buy-form { display: inline-block; }
        button { 
            padding: 8px 15px; 
            margin-right: 5px;
            cursor: pointer;
        }
        .btn-unsafe { background: #ff6b6b; color: white; border: none; }
        .btn-safe { background: #51cf66; color: white; border: none; }
        .message { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="nav">
        <a href="/seats">ğŸ« ì¢Œì„ ì˜ˆì•½</a>
        <a href="/purchases">êµ¬ë§¤ë‚´ì—­</a>
        <a href="/dashboard">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
        <a href="http://localhost:8082" target="_blank">ğŸ“ ê²Œì‹œíŒ</a>
        <a href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
    </div>

    <p style="margin-bottom: 10px;">í™˜ì˜í•©ë‹ˆë‹¤, <strong>{{ username }}</strong>ë‹˜!</p>

    <h1>ğŸ›’ ì•„ì´í…œ ìƒì  (REST API ë°©ì‹)</h1>

    <div id="message-container"></div>

    <p><strong>ë™ì‹œì„± í…ŒìŠ¤íŠ¸:</strong></p>
    <ul>
        <li><span style="color: #ff6b6b;">ë¹¨ê°„ ë²„íŠ¼</span>: ë™ì‹œì„± ë¬¸ì œ ìˆëŠ” êµ¬ë§¤ (Race Condition ë°œìƒ ê°€ëŠ¥)</li>
        <li><span style="color: #51cf66;">ì´ˆë¡ ë²„íŠ¼</span>: ë½ì„ ì‚¬ìš©í•œ ì•ˆì „í•œ êµ¬ë§¤</li>
    </ul>

    <hr>

    <div id="items-container">
        {% for item in items %}
        <div class="item" data-item-id="{{ item.id }}">
            <h3>{{ item.name }}</h3>
            <p>ê°€ê²©: {{ "{:,}".format(item.price) }}ì›</p>
            <p class="stock {% if item.stock < 5 %}low{% endif %}">
                ì¬ê³ : <span class="stock-count">{{ item.stock }}</span>ê°œ
            </p>

            {% if username %}
                {% if item.stock > 0 %}
                    <button class="btn-unsafe" onclick="buyItem({{ item.id }}, false)">
                        ìœ„í—˜í•œ êµ¬ë§¤ (ë™ì‹œì„± âŒ)
                    </button>
                    <button class="btn-safe" onclick="buyItem({{ item.id }}, true)">
                        ì•ˆì „í•œ êµ¬ë§¤ (ë™ì‹œì„± âœ…)
                    </button>
                {% else %}
                    <p style="color: red;">í’ˆì ˆ</p>
                {% endif %}
            {% else %}
                <p><a href="/login">ë¡œê·¸ì¸</a>í•˜ê³  êµ¬ë§¤í•˜ì„¸ìš”</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <script>
        const username = "{{ username }}";

        async function buyItem(itemId, useSafe) {
            if (!username) {
                showMessage('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
                return;
            }

            // ë²„íŠ¼ ë¹„í™œì„±í™”
            const buttons = document.querySelectorAll(`[data-item-id="${itemId}"] button`);
            buttons.forEach(btn => btn.disabled = true);

            try {
                const response = await fetch(`/api/items/${itemId}/purchase`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        use_safe: useSafe
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(result.message, 'success');
                    // ì¬ê³  ì—…ë°ì´íŠ¸
                    updateStock(itemId, result.remaining_stock);
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            } finally {
                // ë²„íŠ¼ ì¬í™œì„±í™”
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            // 3ì´ˆ í›„ ìë™ ì‚­ì œ
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        function updateStock(itemId, newStock) {
            const itemDiv = document.querySelector(`[data-item-id="${itemId}"]`);
            const stockSpan = itemDiv.querySelector('.stock-count');
            stockSpan.textContent = newStock;

            // ì¬ê³ ê°€ 0ì´ë©´ í’ˆì ˆ í‘œì‹œ
            if (newStock === 0) {
                const buttons = itemDiv.querySelectorAll('button');
                buttons.forEach(btn => btn.remove());
                const stockP = itemDiv.querySelector('.stock');
                stockP.insertAdjacentHTML('afterend', '<p style="color: red;">í’ˆì ˆ</p>');
            }

            // ì¬ê³ ê°€ 5 ë¯¸ë§Œì´ë©´ low í´ë˜ìŠ¤ ì¶”ê°€
            const stockP = itemDiv.querySelector('.stock');
            if (newStock < 5) {
                stockP.classList.add('low');
            }
        }
    </script>
</body>
</html>
