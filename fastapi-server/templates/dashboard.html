<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
        }
        .nav {
            margin-bottom: 15px;
        }
        .nav a {
            margin-right: 20px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }
        .nav a:hover {
            color: #764ba2;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .stat-card .change {
            font-size: 14px;
            font-weight: 600;
        }
        .positive {
            color: #10b981;
        }
        .negative {
            color: #ef4444;
        }
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        .chart-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        .status-online {
            background: #10b981;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .activity-log {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }
        .activity-item {
            padding: 12px;
            border-left: 3px solid #667eea;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            transition: background 0.3s;
        }
        .activity-item:hover {
            background: #e9ecef;
        }
        .activity-time {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }
        .activity-text {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="nav">
            <a href="/shop">ğŸ›’ ì‡¼í•‘í•˜ê¸°</a>
            <a href="/seats">ğŸ« ì¢Œì„ ì˜ˆì•½</a>
            <a href="/purchases">êµ¬ë§¤ë‚´ì—­</a>
            <a href="/logout">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
        <span><span class="status-indicator status-online"></span>í™˜ì˜í•©ë‹ˆë‹¤, <strong>{{ username }}</strong>ë‹˜!</span>
    </div>

    <div class="container">
        <h1 style="color: white; margin-bottom: 30px; font-size: 32px;">ğŸ“Š ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ</h1>
        
        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>ğŸ’º ì „ì²´ ì¢Œì„</h3>
                <div class="value" id="totalSeats">0</div>
                <div class="change">ë„ì„œê´€ ì „ì²´ ì¢Œì„</div>
            </div>
            <div class="stat-card">
                <h3>âœ… ì˜ˆì•½ëœ ì¢Œì„</h3>
                <div class="value" id="reservedSeats">0</div>
                <div class="change" id="reservedChange">-</div>
            </div>
            <div class="stat-card">
                <h3>ğŸ†“ ì´ìš© ê°€ëŠ¥</h3>
                <div class="value" id="availableSeats">0</div>
                <div class="change" id="availableChange">-</div>
            </div>
            <div class="stat-card">
                <h3>ğŸ“ˆ ì´ìš©ë¥ </h3>
                <div class="value" id="utilizationRate">0%</div>
                <div class="change" id="utilizationChange">-</div>
            </div>
        </div>

        <!-- ì°¨íŠ¸ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div class="chart-container">
                <div class="chart-title">ì¢Œì„ í˜„í™©</div>
                <div class="chart-wrapper">
                    <canvas id="seatOverviewCanvas"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">ì‹œê°„ëŒ€ë³„ ì˜ˆì•½ ì¶”ì´</div>
                <div class="chart-wrapper">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ì‹¤ì‹œê°„ í™œë™ ë¡œê·¸ -->
        <div class="activity-log">
            <div class="chart-title">ğŸ• ì‹¤ì‹œê°„ í™œë™ ë¡œê·¸</div>
            <div id="activityLog">
                <div class="activity-item">
                    <div class="activity-time">ëŒ€ê¸° ì¤‘...</div>
                    <div class="activity-text">WebSocket ì—°ê²° ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const username = "{{ username }}";
        let initialSeats = {{ initial_seats | safe }};
        
        // ì¢Œì„ í˜„í™© ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
        const seatOverviewCanvas = document.getElementById('seatOverviewCanvas');
        const seatOverviewCtx = seatOverviewCanvas.getContext('2d');
        const seatImage = new Image();
        seatImage.src = '/static/seats.png';

        function resizeSeatCanvas() {
            const wrapper = seatOverviewCanvas.parentElement;
            seatOverviewCanvas.width = wrapper.clientWidth;
            seatOverviewCanvas.height = wrapper.clientHeight;
        }

        function drawSeatOverview(seats) {
            if (!seatImage.complete || seatImage.naturalWidth === 0) {
                seatImage.onload = () => drawSeatOverview(seats);
                return;
            }

            resizeSeatCanvas();

            const canvasWidth = seatOverviewCanvas.width;
            const canvasHeight = seatOverviewCanvas.height;
            const baseWidth = 880;
            const baseHeight = 800;
            const scaleX = canvasWidth / baseWidth;
            const scaleY = canvasHeight / baseHeight;

            seatOverviewCtx.clearRect(0, 0, canvasWidth, canvasHeight);
            seatOverviewCtx.drawImage(seatImage, 0, 0, canvasWidth, canvasHeight);

            seats.forEach(seat => {
                if (seat.status === 'reserved') {
                    seatOverviewCtx.fillStyle = 'rgba(220, 53, 69, 0.7)';
                    seatOverviewCtx.fillRect(
                        seat.x_pos * scaleX,
                        seat.y_pos * scaleY,
                        seat.width * scaleX,
                        seat.height * scaleY
                    );
                }
            });
        }

        const timelineChart = new Chart(
            document.getElementById('timelineChart'),
            {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ì˜ˆì•½ ì¢Œì„ ìˆ˜',
                        data: [],
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            }
        );

        // ì´ì „ ë°ì´í„° ì €ì¥
        let previousData = null;  // nullë¡œ ì´ˆê¸°í™”í•˜ì—¬ ì²« ë¡œë“œ êµ¬ë¶„
        let isFirstLoad = true;

        // WebSocket ì—°ê²°
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/seats`;
        const socket = new WebSocket(wsUrl);

        socket.onopen = () => {
            console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ');
            addActivity('ì‹œìŠ¤í…œ', 'WebSocket ì—°ê²° ì„±ê³µ');
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            if (data.type === 'seat_update' && data.seats) {
                updateDashboard(data.seats, false);
                addActivity(
                    data.username || 'ì‚¬ìš©ì',
                    `ì¢Œì„ ${data.action === 'reserved' ? 'ì˜ˆì•½' : 'ì·¨ì†Œ'} (ì¢Œì„ #${data.seat_id})`
                );
            } else if (data.type === 'all_seats') {
                updateDashboard(data.seats, isFirstLoad);
                if (isFirstLoad) {
                    isFirstLoad = false;
                    addActivity('ì‹œìŠ¤í…œ', 'ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                }
            }
        };

        socket.onerror = (error) => {
            console.error('âŒ WebSocket ì—ëŸ¬:', error);
            addActivity('ì‹œìŠ¤í…œ', 'ì—°ê²° ì˜¤ë¥˜ ë°œìƒ');
        };

        socket.onclose = () => {
            console.log('ğŸ”Œ WebSocket ì—°ê²° ì¢…ë£Œ');
            addActivity('ì‹œìŠ¤í…œ', 'WebSocket ì—°ê²° ì¢…ë£Œ');
        };

        // ì´ˆê¸° ë°ì´í„°ë¡œ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        if (initialSeats && initialSeats.length > 0) {
            console.log('ğŸ“Š ì´ˆê¸° ë°ì´í„° ë¡œë“œ:', initialSeats.length, 'ê°œ');
            updateDashboard(initialSeats, true);
            addActivity('ì‹œìŠ¤í…œ', 'í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
        }

        // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        function updateDashboard(seats, isInitialLoad = false) {
            const total = seats.length;
            const reserved = seats.filter(s => s.status === 'reserved').length;
            const available = total - reserved;
            const utilization = total > 0 ? Math.round((reserved / total) * 100) : 0;

            // í†µê³„ ì—…ë°ì´íŠ¸
            document.getElementById('totalSeats').textContent = total;
            document.getElementById('reservedSeats').textContent = reserved;
            document.getElementById('availableSeats').textContent = available;
            document.getElementById('utilizationRate').textContent = utilization + '%';

            // ë³€í™”ëŸ‰ í‘œì‹œ (ì´ˆê¸° ë¡œë“œê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
            if (isInitialLoad || previousData === null) {
                // ì´ˆê¸° ë¡œë“œ ì‹œ ë³€í™”ëŸ‰ ëŒ€ì‹  í˜„ì¬ ìƒíƒœ í‘œì‹œ
                document.getElementById('reservedChange').innerHTML = '<span>í˜„ì¬ ìƒíƒœ</span>';
                document.getElementById('availableChange').innerHTML = '<span>í˜„ì¬ ìƒíƒœ</span>';
                document.getElementById('utilizationChange').innerHTML = '<span>í˜„ì¬ ìƒíƒœ</span>';
            } else {
                const reservedChange = reserved - previousData.reserved;
                const availableChange = available - previousData.available;
                const utilizationChange = utilization - previousData.utilization;

                document.getElementById('reservedChange').innerHTML = 
                    reservedChange > 0 ? `<span class="positive">â–² ${reservedChange}</span>` :
                    reservedChange < 0 ? `<span class="negative">â–¼ ${Math.abs(reservedChange)}</span>` :
                    '<span>-</span>';

                document.getElementById('availableChange').innerHTML = 
                    availableChange > 0 ? `<span class="positive">â–² ${availableChange}</span>` :
                    availableChange < 0 ? `<span class="negative">â–¼ ${Math.abs(availableChange)}</span>` :
                    '<span>-</span>';

                document.getElementById('utilizationChange').innerHTML = 
                    utilizationChange > 0 ? `<span class="positive">â–² ${utilizationChange}%</span>` :
                    utilizationChange < 0 ? `<span class="negative">â–¼ ${Math.abs(utilizationChange)}%</span>` :
                    '<span>-</span>';
            }

            // ì¢Œì„ í˜„í™© ìº”ë²„ìŠ¤ ì—…ë°ì´íŠ¸
            drawSeatOverview(seats);

            // íƒ€ì„ë¼ì¸ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            const now = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            timelineChart.data.labels.push(now);
            timelineChart.data.datasets[0].data.push(reserved);
            
            // ìµœëŒ€ 20ê°œ ë°ì´í„°ë§Œ ìœ ì§€
            if (timelineChart.data.labels.length > 20) {
                timelineChart.data.labels.shift();
                timelineChart.data.datasets[0].data.shift();
            }
            
            timelineChart.update();

            // ì´ì „ ë°ì´í„° ì €ì¥
            previousData = { reserved, available, utilization };
        }

        // í™œë™ ë¡œê·¸ ì¶”ê°€
        function addActivity(user, action) {
            const logContainer = document.getElementById('activityLog');
            const now = new Date().toLocaleString('ko-KR');
            
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            activityItem.innerHTML = `
                <div class="activity-time">${now}</div>
                <div class="activity-text"><strong>${user}</strong> - ${action}</div>
            `;
            
            logContainer.insertBefore(activityItem, logContainer.firstChild);
            
            // ìµœëŒ€ 50ê°œ ë¡œê·¸ë§Œ ìœ ì§€
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }
    </script>
</body>
</html>
